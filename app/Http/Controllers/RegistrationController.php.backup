<?php

namespace App\Http\Controllers;

use App\Models\Program;
use App\Models\Registration;
use App\Models\Schedule;
use App\Models\Promo;
use App\Models\PaymentProof;
use App\Services\IdGeneratorService;
use App\Services\AuditLoggerService;
use Illuminate\Http\Request;

class RegistrationController extends Controller
{
    // ==================== STEP 1 ====================
    public function index()
    {
        return view('registration.step1-intro');
    }

    // ==================== STEP 1 ==================== (Section 1: Who to register)
    public function step1Show()
    {
        return view('registration.step1-registrar');
    }

    public function step1Submit(Request $request)
    {
        $validated = $request->validate([
            'is_parent_register' => 'required|in:yes,no',
        ]);

        return redirect()->route('registration.step2')->with($validated)->withInput();
    }

    // ==================== STEP 3 ====================
    public function step3Show(Request $request)
    {
        return view('registration.step3-education');
    }

    public function step3Submit(Request $request)
    {
        $validated = $request->validate([
            'is_parent_register' => 'required|in:yes,no',
            'education_level' => 'required|string|in:TK,SD,SMP,SMA,Mahasiswa,Umum',
            'class_level' => 'nullable|string|max:50',
        ]);

        return redirect()->route('registration.step4')->with($validated)->withInput();
    }

    // ==================== STEP 4 ==================== (Student Data - Section 3)
    public function step4Show(Request $request)
    {
        return view('registration.step4-student-data');
    }

    public function step4Submit(Request $request)
    {
        $validated = $request->validate([
            'student_name' => 'required|string|max:255',
            'student_birthdate' => 'required|date|before:today',
            'student_identity_number' => 'required|string|max:50',
            'student_gender' => 'required|in:male,female',
            'student_province' => 'required|string|max:100',
            'student_regency' => 'required|string|max:100',
            'student_district' => 'required|string|max:100',
            'student_village' => 'required|string|max:100',
            'student_address_detail' => 'required|string',
            'student_phone' => 'nullable|string|max:20',
            'student_email' => 'nullable|email',
            'is_parent_register' => 'required|in:yes,no',
            'parent_name' => 'nullable|string|max:255',
            'parent_identity_number' => 'nullable|string|max:50',
            'parent_relationship' => 'nullable|string|max:50',
            'parent_phone' => 'nullable|string|max:20',
            'parent_email' => 'nullable|email',
            'parent_province' => 'nullable|string|max:100',
            'parent_regency' => 'nullable|string|max:100',
            'parent_district' => 'nullable|string|max:100',
            'parent_village' => 'nullable|string|max:100',
            'parent_address_detail' => 'nullable|string',
            'student_job' => 'nullable|string|max:100',
        ]);

        // Age validation for self-registration
        if ($request->input('is_parent_register') === 'no') {
            $birthdate = new \DateTime($request->input('student_birthdate'));
            $today = new \DateTime();
            $age = $today->diff($birthdate)->y;

            if ($age < 18) {
                // Require parent data
                $request->validate([
                    'parent_name' => 'required|string|max:255',
                    'parent_identity_number' => 'required|string|max:50',
                    'parent_relationship' => 'required|string|max:50',
                    'parent_phone' => 'required|string|max:20',
                    'parent_province' => 'required|string|max:100',
                    'parent_regency' => 'required|string|max:100',
                    'parent_district' => 'required|string|max:100',
                    'parent_village' => 'required|string|max:100',
                    'parent_address_detail' => 'required|string',
                ]);
            }
        }

        return redirect()->route('registration.step5')->with($validated)->withInput();
    }

    // ==================== STEP 5 ==================== (Program & Service - Section 4)
    public function step5Show(Request $request)
    {
        $educationLevel = $request->get('education_level') ?? old('education_level');
        $classLevel = $request->get('class_level') ?? old('class_level');

        if (!$educationLevel) {
            return redirect()->route('registration.step4');
        }

        // Determine service type based on education level
        $serviceType = '';
        if (in_array($educationLevel, ['TK', 'SD'])) {
            $serviceType = 'SIMY';
        } elseif (in_array($educationLevel, ['SMP', 'SMA'])) {
            $serviceType = 'SITRA';
        } elseif (in_array($educationLevel, ['Mahasiswa', 'Umum'])) {
            $serviceType = 'SINTAS';
        }

        $query = Program::where('education_level', $educationLevel)
            ->where('service_type', $serviceType)
            ->where('is_active', true);

        // Filter by class if applicable (for now, assume programs don't have class, but can add later)
        // if ($classLevel && in_array($educationLevel, ['TK', 'SD', 'SMP', 'SMA'])) {
        //     $query->where('class_level', $classLevel);
        // }

        $programs = $query->get();

        return view('registration.step5-program-service', compact('programs', 'educationLevel', 'serviceType', 'classLevel'));
    }

    public function step5Submit(Request $request)
    {
        $validated = $request->validate([
            'program_id' => 'required|exists:programs,id',
        ]);

        return redirect()->route('registration.step6')->with($validated)->withInput();
    }

    // ==================== STEP 6 ==================== (Review Promo - Section 5)
    public function step6Show(Request $request)
    {
        $programId = $request->get('program_id') ?? old('program_id');
        $studentBirthdate = $request->get('student_birthdate') ?? old('student_birthdate');

        if (!$programId || !$studentBirthdate) {
            return redirect()->route('registration.step5');
        }

        $program = Program::findOrFail($programId);

        // Calculate age
        $birthdate = new \DateTime($studentBirthdate);
        $today = new \DateTime();
        $studentAge = $today->diff($birthdate)->y;

        return view('registration.step6-review-promo', compact('program', 'studentAge'));
    }

    public function step6Submit(Request $request)
    {
        $validated = $request->validate([
            'agree_terms' => 'required|accepted',
            'agree_contract' => 'required|accepted',
            'promo_code' => 'nullable|string|max:50',
            'payment_choice' => 'required|in:pay_now,pay_later',
        ]);

        $paymentChoice = $request->input('payment_choice');

        if ($paymentChoice === 'pay_later') {
            // Create registration with pending_payment status, skip payment step
            return $this->createRegistration($request, 'pending_payment');
        } else {
            // Proceed to payment step
            return redirect()->route('registration.step8')->withInput();
        }
    }

    // ==================== STEP 7 ==================== (Summary - Section 6)
    public function step7Show(Request $request)
    {
        $programId = $request->get('program_id') ?? old('program_id');
        $studentBirthdate = $request->get('student_birthdate') ?? old('student_birthdate');

        if (!$programId || !$studentBirthdate) {
            return redirect()->route('registration.step6');
        }

        $program = Program::findOrFail($programId);

        // Calculate age
        $birthdate = new \DateTime($studentBirthdate);
        $today = new \DateTime();
        $studentAge = $today->diff($birthdate)->y;

        return view('registration.step7-summary', compact('program', 'studentAge'));
    }

    public function step7Submit(Request $request)
    {
        // Just proceed to payment
        return redirect()->route('registration.step8')->withInput();
    }

    // ==================== STEP 8 ==================== (Payment - Section 7)
    public function step8Show(Request $request)
    {
        $programId = $request->get('program_id') ?? old('program_id');

        if (!$programId) {
            return redirect()->route('registration.step7');
        }

        $program = Program::findOrFail($programId);

        return view('registration.step8-payment', compact('program'));
    }

    public function step8Submit(Request $request)
    {
        $validated = $request->validate([
            'payment_choice' => 'required|in:pay_now,pay_later',
        ]);

        $paymentChoice = $request->input('payment_choice');

        if ($paymentChoice === 'pay_later') {
            // Create registration with pending_payment status, skip payment step
            return $this->createRegistration($request, 'pending_payment');
        } else {
            // Create registration and proceed to payment upload
            $registration = $this->createRegistration($request, 'awaiting_verification', true);
            return redirect()->route('registration.step9', $registration->id);
        }
    }

    private function createRegistration(Request $request, $status = 'pending_payment', $returnObject = false)
    {
        // Validate promo code if provided
        $promoCode = $request->input('promo_code');

        // Get all data from request (which includes session via request helper)
        $programId = $request->get('program_id') ?? old('program_id');

        if (!$programId) {
            return redirect()->route('registration.step7');
        }

        $program = Program::findOrFail($programId);

        // Auto-assign first available schedule
        $schedule = Schedule::where('program_id', $program->id)
            ->where('is_active', true)
            ->first();

        if (!$schedule) {
            return redirect()->route('registration.step5')->with(['error' => 'Tidak ada jadwal tersedia untuk program ini']);
        }

        $scheduleId = $schedule->id;

        // Get all student data using request()->all() which includes session
        $studentName = $request->get('student_name') ?? old('student_name');
        $studentBirthdate = $request->get('student_birthdate') ?? old('student_birthdate');
        $studentIdentityNumber = $request->get('student_identity_number') ?? old('student_identity_number');
        $studentGender = $request->get('student_gender') ?? old('student_gender');
        $studentProvince = $request->get('student_province') ?? old('student_province');
        $studentRegency = $request->get('student_regency') ?? old('student_regency');
        $studentDistrict = $request->get('student_district') ?? old('student_district');
        $studentVillage = $request->get('student_village') ?? old('student_village');
        $studentAddressDetail = $request->get('student_address_detail') ?? old('student_address_detail');
        $studentAddress = $studentProvince . ', ' . $studentRegency . ', ' . $studentDistrict . ', ' . $studentVillage . ', ' . $studentAddressDetail;
        $studentPhone = $request->get('student_phone') ?? old('student_phone');
        $studentEmail = $request->get('student_email') ?? old('student_email');
        $isParentRegister = $request->get('is_parent_register') ?? old('is_parent_register');
        $studentJob = $request->get('student_job') ?? old('student_job');

        // Parent data
        $parentName = $request->get('parent_name') ?? old('parent_name');
        $parentIdentityNumber = $request->get('parent_identity_number') ?? old('parent_identity_number');
        $parentRelationship = $request->get('parent_relationship') ?? old('parent_relationship');
        $parentPhone = $request->get('parent_phone') ?? old('parent_phone');
        $parentEmail = $request->get('parent_email') ?? old('parent_email');
        $parentProvince = $request->get('parent_province') ?? old('parent_province');
        $parentRegency = $request->get('parent_regency') ?? old('parent_regency');
        $parentDistrict = $request->get('parent_district') ?? old('parent_district');
        $parentVillage = $request->get('parent_village') ?? old('parent_village');
        $parentAddressDetail = $request->get('parent_address_detail') ?? old('parent_address_detail');
        $parentAddress = $parentProvince ? $parentProvince . ', ' . $parentRegency . ', ' . $parentDistrict . ', ' . $parentVillage . ', ' . $parentAddressDetail : null;

        // Verify all required data is present
        if (!$studentName || !$studentBirthdate || !$studentIdentityNumber) {
            return redirect()->route('registration.step4')->with(['error' => 'Data tidak lengkap']);
        }

        // Generate IDs
        $orderId = IdGeneratorService::generateOrderId();
        $studentId = IdGeneratorService::generateStudentId();
        $invoiceId = IdGeneratorService::generateInvoiceId();

        // Calculate age
        $birthdate = new \DateTime($studentBirthdate);
        $today = new \DateTime();
        $studentAge = $today->diff($birthdate)->y;

        // Calculate discount if promo exists
        $discountAmount = 0;
        if ($promoCode) {
            $promo = Promo::where('promo_code', strtoupper($promoCode))
                ->where('is_active', true)
                ->first();

            if ($promo && $promo->isValid()) {
                $discountAmount = $promo->calculateDiscount($program->price);
            }
        }

        // Create registration
        $registration = Registration::create([
            'order_id' => $orderId,
            'student_id' => $studentId,
            'invoice_id' => $invoiceId,
            'program_id' => $programId,
            'schedule_id' => $scheduleId,
            'student_name' => $studentName,
            'student_birthdate' => $studentBirthdate,
            'student_identity_number' => $studentIdentityNumber,
            'student_gender' => $studentGender,
            'student_address' => $studentAddress,
            'student_phone' => $studentPhone,
            'student_email' => $studentEmail,
            'student_job' => $studentJob,
            'parent_name' => $parentName,
            'parent_identity_number' => $parentIdentityNumber,
            'parent_phone' => $parentPhone,
            'parent_email' => $parentEmail,
            'parent_relationship' => $parentRelationship,
            'parent_address' => $parentAddress,
            'is_parent_register' => $isParentRegister === 'yes',
            'student_age' => $studentAge,
            'status' => $status,
            'base_price' => $program->price,
            'discount_amount' => $discountAmount,
            'tax_amount' => 0,
            'total_amount' => $program->price - $discountAmount,
            'payment_status' => $status === 'pending_payment' ? 'unpaid' : 'pending',
        ]);

        // Log audit
        AuditLoggerService::log('created', 'Registration', $registration->id, [], "Order {$orderId} created");

        // Notify admins
        $notificationType = $status === 'pending_payment' ? 'registration_pay_later' : 'registration_pay_now';
        $title = $status === 'pending_payment' ? 'Pendaftaran Baru - Bayar Nanti' : 'Pendaftaran Baru - Menunggu Pembayaran';
        $message = "Pendaftaran baru dari {$studentName} untuk program {$program->name}. Order ID: {$orderId}";
        \App\Services\NotificationService::notifyAdmins($notificationType, $title, $message, [
            'registration_id' => $registration->id,
            'order_id' => $orderId,
            'student_name' => $studentName,
            'program_name' => $program->name,
            'service_type' => $program->service_type,
        ]);

        if ($returnObject) {
            return $registration;
        }

        if ($status === 'pending_payment') {
            return redirect()->route('registration.step9', $registration->id);
        } else {
            return redirect()->route('registration.step9', $registration->id);
        }
    }

    // ==================== STEP 9 ==================== (Confirmation)
    public function step9Show(Registration $registration)
    {
        return view('registration.step9-confirmation', compact('registration'));
    }

    public function step9Submit(Request $request, Registration $registration)
    {
        $validated = $request->validate([
            'proof_file' => 'required|file|mimes:jpg,jpeg,png,pdf|max:5120',
            'bank_name' => 'required|string|max:100',
            'sender_name' => 'required|string|max:100',
            'amount' => 'required|numeric|min:0',
            'transfer_date' => 'required|date_format:Y-m-d\TH:i',
            'notes' => 'nullable|string',
        ]);

        // Store file
        $filePath = $request->file('proof_file')->store('payment_proofs/' . $registration->order_id, 'public');

        // Create payment proof
        PaymentProof::create([
            'registration_id' => $registration->id,
            'file_path' => $filePath,
            'file_name' => $request->file('proof_file')->getClientOriginalName(),
            'bank_name' => $validated['bank_name'],
            'sender_name' => $validated['sender_name'],
            'amount' => $validated['amount'],
            'transfer_date' => $validated['transfer_date'],
            'status' => 'pending',
        ]);

        // Update registration
        $registration->update([
            'status' => 'awaiting_verification',
            'payment_status' => 'pending',
        ]);

        // Log audit
        AuditLoggerService::log('payment_proof_uploaded', 'Registration', $registration->id, [], 'Bukti pembayaran diupload');

        return redirect()->route('registration.step10', $registration->id);
    }

    // ==================== STEP 10 ====================
    public function step10Show(Registration $registration)
    {
        return view('registration.step10-confirmation', compact('registration'));
    }
}
